<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8"/>
        <title>Contentful UI extension to select Shopify products with full product data</title>
        <link rel="stylesheet" href="https://contentful.github.io/ui-extensions-sdk/cf-extension.css">
        <style>
            .product.selectedProduct {
                display: none;
                cursor: default !important;
                margin-bottom: 40px;
            }

            .selectedProduct.active {
                display: inline-block;
            }

            .product.selectedProduct:hover {
                background-color: transparent;
            }

            .product.selectedProduct .product-image {
                margin-top: 30px;
            }

            .product-delete {
                cursor: pointer;
                border: 1px solid #000000;
                border-radius: 50%;
                width: 18px;
                height: 18px;
                float: right;
                text-align: center;
            }

            .product-delete:hover {
                background-color: #000000;
                color: #ffffff;
            }

            .product-grid {
                display: flex;
                flex-wrap: wrap;
                margin-top: 40px;
            }

            .product {
                border: 1px solid #F3F3F3;
                padding: 10px;
                cursor: pointer;
                width: 200px;
                margin-left: 20px;
                margin-bottom: 20px;
            }

            .product:hover {
                background-color: #F3F3F3;
            }

            .product-image {
                width: 100%;
                height: 0;
                padding-bottom: 100%;
                background-position: center;
                background-size: cover;
            }

            .product-title {
                margin-top: 10px;
                text-align: center;
                font-weight: bold;
            }
        </style>
    </head>
    <body id="shopify-widget">
        <div id="content">
            <div class="selectedProduct product" product-wrapper>
                <div class="product-delete" product-delete>X</div>
                <div class="selectedProductImage product-image" product-image></div>
                <div class="selectedProductTitle product-title" product-title></div>
            </div>
            <input id="productQuery" class="cf-form-input" type="string" placeholder="Shirt men" />
            <div class="cf-form-label">
                <label for="productQuery">Search products</label>
            </div>
            <div class="product-grid"></div>
        </div>
        <script src="https://unpkg.com/contentful-ui-extensions-sdk"></script>
        <script src="https://unpkg.com/jquery"></script>
        <script>
            // jquery throttle -> https://raw.githubusercontent.com/cowboy/jquery-throttle-debounce/v1.1/jquery.ba-throttle-debounce.min.js
            (function(b,c){var $=b.jQuery||b.Cowboy||(b.Cowboy={}),a;$.throttle=a=function(e,f,j,i){var h,d=0;if(typeof f!=="boolean"){i=j;j=f;f=c}function g(){var o=this,m=+new Date()-d,n=arguments;function l(){d=+new Date();j.apply(o,n)}function k(){h=c}if(i&&!h){l()}h&&clearTimeout(h);if(i===c&&m>e){l()}else{if(f!==true){h=setTimeout(i?k:l,i===c?e-m:e)}}}if($.guid){g.guid=j.guid=j.guid||$.guid++}return g};$.debounce=function(d,e,f){return f===c?a(d,e,false):a(d,f,e!==false)}})(this);
        </script>
        <script>
            window.contentfulExtension.init(extension => {
                // Size iframe
                extension.window.startAutoResizer();

                const $products             = $(".product-grid");
                const $select               = $("#productQuery");
                const $selectedDelete       = $("[product-delete]");
                const $selectedProduct      = $("[product-wrapper]");
                const $selectedProductImage = $("[product-image]");
                const $selectedProductTitle = $("[product-title]");

                // Set initial value
                const value = extension.field.getValue();

                if (value && !jQuery.isEmptyObject(value)) {
                    $selectedProduct.addClass("active");
                    $selectedProductTitle.text(value.title);

                    const initImage = value.images && value.images.length > 0 ? value.images[0].transformedSrc : "";
                    $selectedProductImage.css("background-image", "url(" + initImage + ")");
                }

                // Remove selected product on delete button event
                $selectedDelete.on("click", function() {
                    extension.field.setValue(null);
                    $selectedProduct.removeClass("active");
                });

                $select.on(
                    "keydown",
                    $.throttle(250, event => {
                        productLookup(event.target.value).then(response => {
                            const products = response && response.data && response.data.shop && response.data.shop.products ? response.data.shop.products.edges : [];
                            renderProducts(products);
                        });
                    })
                );

                function cleanProduct(product) {
                    _product = {};

                    if (product) {
                        if (product.collections.edges && product.collections.edges.length > 0) {
                            const values = product.collections.edges.map(v => v.node);
                            product.collections = values;
                        }

                        if (product.images.edges && product.images.edges.length > 0) {
                            const values = product.images.edges.map(v => v.node);
                            product.images = values;
                        }

                        if (product.variants.edges && product.variants.edges.length > 0) {
                            const values = product.variants.edges.map(v => v.node);
                            product.variants = values;
                        }

                        _product = product;
                    }

                    return _product;
                };

                function renderProducts(products) {
                    $products.html("");

                    $.each(products, function(i, item) {
                        const cleanedProduct = cleanProduct(item.node);
                        const image          = cleanedProduct.images && cleanedProduct.images.length > 0 ? cleanedProduct.images[0].transformedSrc : "";
                        const inner          = '<div class="product" data-product-select="' + cleanedProduct.id + '"><div class="product-image" style="background-image:url(' + image + ')"></div><div class="product-title">' + item.node.title + "</div></div>";

                        $products.append(inner);
                    });

                    $("[data-product-select]").on("click", function () {
                        // Find selected id in array of products && set field
                        const id                  = $(this).data("product-select");
                        const selectedProductItem = products.filter(item => item.node.id === id);
                        const selectedProduct     = selectedProductItem && selectedProductItem.length > 0 ? selectedProductItem[0].node : {};

                        extension.field.setValue(selectedProduct);

                        if (selectedProduct) {
                            $selectedProduct.addClass("active");
                            $selectedProductTitle.text(selectedProduct.title);

                            const selectedImage = selectedProduct.images && selectedProduct.images.length > 0 ? selectedProduct.images[0].transformedSrc : "";
                            $selectedProductImage.css("background-image", "url(" + selectedImage + ")");
                        } else {
                            $selectedProduct.removeClass("active");
                        }

                        // After Product selected, get rid of grid
                        $products.empty();
                    });
                };

                function productLookup(query) {
                    return $.ajax({
                        cache: true,
                        method: "POST",
                        headers: {
                            "X-Shopify-Storefront-Access-Token": extension.parameters.instance.apiToken,
                            "Content-Type": "application/graphql"
                        },
                        url: extension.parameters.instance.apiEndpoint,
                        data: `
                        {
                            shop {
                                name
                                products(first: 10, query: "${query}") {
                                    edges {
                                        node {
                                            availableForSale
                                            collections(first: 10) {
                                                edges {
                                                    node {
                                                        handle
                                                        description
                                                        title
                                                    }
                                                }
                                            }
                                            createdAt
                                            description
                                            handle
                                            id
                                            images(first: 1) {
                                                edges {
                                                    node {
                                                        altText
                                                        id
                                                        originalSrc
                                                        transformedSrc
                                                    }
                                                }
                                            }
                                            onlineStoreUrl
                                            priceRange {
                                                maxVariantPrice {
                                                    amount
                                                    currencyCode
                                                }
                                                minVariantPrice {
                                                    amount
                                                    currencyCode
                                                }
                                            }
                                            productType
                                            publishedAt
                                            tags
                                            title
                                            updatedAt
                                            vendor
                                            variants(first: 100) {
                                                edges {
                                                    node {
                                                        availableForSale
                                                        compareAtPrice
                                                        id
                                                        image {
                                                            altText
                                                            id
                                                            originalSrc
                                                            transformedSrc
                                                        }
                                                        price
                                                        sku
                                                        title
                                                        weight
                                                        weightUnit
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        `
                    });
                };
            });
        </script>
    </body>
</html>